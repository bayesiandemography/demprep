---
title: "Locating events in an age-time plan"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Locating events in an age-time plan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  fig.width = 6.5
)
deaths <- data.frame(person = c("Anwar", "Baptiste", "Candice"),
                     date = c("2019-10-11", "2020-02-27", "2020-08-01"))
```

# Introduction

- Raw individual-level data uses dates - birth, occurrence, measurement
- Demographic analyses use intervals - periods, age, cohort, triangle
- functions for converting
- lots of subtle details

```{r}
library(demprep)
```


# Age-time plans in demography


# Design of functions in 'demprep'


# Periods

## Single-year periods

```{r}
deaths_yr <- deaths
deaths_yr$jan_true <- date_to_period_year(date = deaths_yr$date)
deaths_yr
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_year(date = deaths_yr$date)
```


```{r}
deaths_yr$jul_true <- date_to_period_year(date = deaths_yr$date,
                                          month_start = "Jul")
deaths_yr
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_year(date = deaths_yr$date,
                         month_start = "Jul")
```


```{r}
deaths_yr$jul_false <- date_to_period_year(date = deaths_yr$date,
                                           month_start = "Jul",
                                           label_year_start = FALSE)
deaths_yr
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_year(date = deaths_yr$date,
                         month_start = "Jul",
                         label_year_start = FALSE)
```



```{r}
deaths_yr$jan_false <- date_to_period_year(date = deaths_yr$date,
                                           month_start = "Jan",
                                           label_year_start = FALSE)
deaths_yr
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_year(date = deaths_yr$date,
                         month_start = "Jan",
                         label_year_start = FALSE)
```


## Multi-year periods, with equal lengths


```{r}
deaths_multi <- deaths
deaths_multi$jan_5_00 <- date_to_period_multi(date = deaths_multi$date)
deaths_multi
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_multi(date = deaths_multi$date)
```


```{r}
deaths_multi$jul_5_00 <- date_to_period_multi(date = deaths_multi$date,
                                              month_start = "Jul")
deaths_multi
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_multi(date = deaths_multi$date,
                          month_start = "Jul")
```



```{r}
deaths_multi$jan_10_00 <- date_to_period_multi(date = deaths_multi$date,
                                               width = 10)
deaths_multi
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_multi(date = deaths_multi$date,
                          width = 10)
```





```{r}
deaths_multi$jan_5_01 <- date_to_period_multi(date = deaths_multi$date,
                                              origin = 2001)
deaths_multi
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_multi(date = deaths_multi$date,
                          origin = 2001)
```


## Multi-year periods, with varying lengths


```{r}
deaths_custom <- deaths
deaths_custom$jan_4_5 <- date_to_period_custom(date = deaths_custom$date,
                                              breaks = c("2016-01-01", "2020-01-01", "2025-01-01"))
deaths_custom
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_custom(date = deaths_custom$date,
                           breaks = c("2016-01-01", "2020-01-01", "2025-01-01"))
```


```{r}
deaths_custom <- deaths
deaths_custom$jan_1_5 <- date_to_period_custom(date = deaths_custom$date,
                                              breaks = c("2019-01-01", "2020-01-01", "2025-01-01"))
deaths_custom
```

```{r, echo = FALSE, fig.height = 1.75}
plot_date_to_period_custom(date = deaths_custom$date,
                           breaks = c("2019-01-01", "2020-01-01", "2025-01-01"))
```


```{r}
deaths_custom <- deaths
deaths_custom$jul_1_5 <- date_to_period_custom(date = deaths_custom$date,
                                               breaks = c("2019-07-01", "2020-07-01", "2025-07-01"))
deaths_custom
```

```{r, echo = FALSE, fig.height = 1.5}
plot_date_to_period_custom(date = deaths_custom$date,
                           breaks = c("2019-07-01", "2020-07-01", "2025-07-01"))
```

# Age groups

Abstract: $\text{age} = t_{\text{event}} - t_{\text{dob}}$

Complications. 

- Child born on 31 October. On what day does child become 1 month old? 
- Child born on 30 November. On what day does child become 1 month old?
- Child born on 29 February 2000. On what day does child become 1 year old?

## Age in completed months

\begin{equation}
    \begin{split}
  \text{age in completed months} & = 12 \times (\text{year of event} - \text{year of birth}) \\
  & \quad + \text{month of event} - \text{month of birth} \\
  & \quad - \text{partial-month adjustment}
    \end{split}
\end{equation}

Partial-month adjustment: ff $\text{day of event} \ge \text{day of birth}$, then 0; otherwise 1.


## Age in completed quarters

\begin{equation}
  \text{age in completed quarters} = \text{floor}(\text{age in completed months} / 3)
\end{equation}


## Age in completed years

\begin{equation}
  \text{age in completed quarters} = \text{floor}(\text{age in completed months} / 12)
\end{equation}

  
| Relationship between dates | Age in completed years |
|:---------------------------|:-----------------------|
| $\text{month of event} > \text{month of birth}$ | $\text{year of event} - \text{year of birth}$ |
| $\text{month of event} = \text{month of birth}$, $\text{day of event} \ge \text{day of birth}$ | $\text{year of event} - \text{year of birth}$ |
| $\text{month of event} = \text{month of birth}$, $\text{day of event} \lt \text{day of birth}$ | $\text{year of event} - \text{year of birth} - 1$ |
| $\text{month of event} < \text{month of birth}$ | $\text{year of event} - \text{year of birth} - 1$ |

 

# Cohorts


# Lexis triangles

- age and time use same length steps (subject to complications of months and years having different lengths)
    - one month; one quarter; one year; $n$ years
- age and time not enough to identify cohort; also need Lexis triangle
- abstract: 
- event is in upper Lexis triangle
    
- An event occurring during period $t$ to a person in age group $a$ belongs to the upper Lexis triangle if the person was already in age group $a$ at the start of the period, and to the lower Lexis triangle otherwise. (Covers youngest and oldest age groups.)










